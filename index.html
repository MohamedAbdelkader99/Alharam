<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الحرم المكي - محاكاة الطواف</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #0f172a;
      --card: rgba(255, 255, 255, 0.08);
      --border: rgba(255, 255, 255, 0.14);
      --accent: #f5c400;
      --text: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      font-family: 'Noto Sans Arabic', 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(245, 196, 0, 0.12), transparent 25%),
                  radial-gradient(circle at 80% 10%, rgba(255, 255, 255, 0.12), transparent 30%),
                  var(--bg);
      color: var(--text);
      line-height: 1.7;
    }

    header {
      position: relative;
      overflow: hidden;
      min-height: 360px;
      display: grid;
      place-items: center;
      text-align: center;
      isolation: isolate;
      color: #0b1320;
    }

    header::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.65), rgba(15, 23, 42, 0.9)),
                  url('https://images.unsplash.com/photo-1541945593100-4e3123d5e25f?auto=format&fit=crop&w=1600&q=90') center/cover;
      transform: scale(1.05);
      z-index: -2;
    }

    header::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), transparent 40%, rgba(15, 23, 42, 0.8));
      z-index: -1;
    }

    .hero-content {
      max-width: 780px;
      padding: 48px 20px 64px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: clamp(28px, 4vw, 48px);
      letter-spacing: 0.4px;
    }

    p.lead {
      margin: 0;
      font-size: clamp(17px, 2vw, 20px);
      opacity: 0.9;
    }

    main {
      padding: 36px 18px 56px;
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      gap: 18px;
      grid-template-columns: 1fr 360px;
    }

    @media (max-width: 1024px) {
      main { grid-template-columns: 1fr; }
      .side-panel { order: -1; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      backdrop-filter: blur(12px);
    }

    .canvas-wrap {
      position: relative;
      overflow: hidden;
      padding: 16px;
      border-radius: 20px;
      background: radial-gradient(circle at 35% 15%, rgba(255, 214, 120, 0.1), transparent 35%),
                  radial-gradient(circle at 70% 85%, rgba(80, 200, 255, 0.08), transparent 28%);
    }

    canvas {
      width: 100%;
      height: 560px;
      border-radius: 16px;
      display: block;
      background: radial-gradient(circle at center, rgba(12, 16, 28, 0.96) 0%, rgba(12, 18, 32, 0.94) 52%, rgba(12, 18, 32, 0.9));
      border: 1px solid var(--border);
    }

    .kaaba {
      position: absolute;
      inset: 50%;
      width: 118px;
      height: 128px;
      transform: translate(-50%, -50%) scale(1) perspective(600px) rotateX(6deg);
      background: linear-gradient(135deg, #0b0b0b 0%, #161616 50%, #050505 100%);
      border-radius: 10px;
      box-shadow: 0 20px 48px rgba(0,0,0,0.55), inset 0 0 0 4px #000, inset 0 0 0 9px rgba(245, 196, 0, 0.05);
      pointer-events: none;
    }

    .kaaba::before {
      content: "";
      position: absolute;
      top: 25%; left: -14%;
      width: 140%; height: 18px;
      background: linear-gradient(90deg, #f5c400, #f8d64e);
      box-shadow: 0 0 16px rgba(245, 196, 0, 0.35);
    }

    .kaaba::after {
      content: "";
      position: absolute;
      inset: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 6px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.4);
    }

    .kaaba .door {
      position: absolute;
      display: block;
      right: 12px;
      bottom: 18px;
      width: 32px;
      height: 50px;
      background: linear-gradient(180deg, #f7d260, #e7b700);
      border-radius: 4px;
      box-shadow: 0 0 14px rgba(245, 196, 0, 0.35);
    }

    .controls {
      padding: 18px 18px 8px;
      display: grid;
      gap: 12px;
    }

    .control-group {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      padding: 12px 14px;
      border-radius: 14px;
      display: grid;
      gap: 10px;
    }

    label { font-weight: 600; }

    input, select, button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      color: var(--text);
    }

    input[type="color"] {
      padding: 0;
      height: 44px;
    }

    input[type="range"] {
      accent-color: var(--accent);
    }

    button {
      background: linear-gradient(135deg, #f5c400, #f8d64e);
      color: #0f172a;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(245, 196, 0, 0.35); }

    .nationality-list {
      display: grid;
      gap: 10px;
      max-height: 320px;
      overflow: auto;
      padding-bottom: 8px;
    }

    .nationality-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 8px;
      background: rgba(255,255,255,0.05);
    }

    .nationality-header {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(245, 196, 0, 0.18);
      border-radius: 999px;
      color: #f9e3a6;
      font-weight: 700;
      font-size: 14px;
    }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .stat {
      display: grid;
      gap: 4px;
      font-size: 14px;
    }

    .stat strong { color: #fff; }

    .muted { opacity: 0.8; font-size: 13px; }

    .footer-note {
      text-align: center;
      color: rgba(255,255,255,0.7);
      margin-top: 18px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <div class="hero-content">
      <h1>الحرم المكي بأبهى صوره</h1>
      <p class="lead">استكشف محاكاة حية للطواف بإطلالة شبه ثلاثية الأبعاد تحاكي الجولة الافتراضية، مع إمكانية ضبط عدد الزوار حسب الجنسية وسرعة حركتهم وجودة تمثيلهم البصري.</p>
    </div>
  </header>

  <main>
    <section class="card canvas-wrap">
      <div class="kaaba" aria-hidden="true"><span class="door"></span></div>
      <canvas id="tawafCanvas" aria-label="محاكاة الطواف حول الكعبة"></canvas>
    </section>

    <aside class="card side-panel">
      <div class="controls">
        <div class="control-group">
          <label for="name">إضافة جنسية جديدة</label>
          <input id="name" type="text" placeholder="مثال: المغرب" />
          <div class="meta-grid">
            <div class="stat">
              <span class="muted">عدد الأفراد</span>
              <input id="count" type="number" min="1" max="300" value="25">
            </div>
            <div class="stat">
              <span class="muted">السرعة (دورات/ثانية)</span>
              <input id="speed" type="number" step="0.1" min="0.1" max="2.5" value="0.8">
            </div>
          </div>
          <div class="meta-grid">
            <div class="stat">
              <span class="muted">لون المجموعات</span>
              <input id="color" type="color" value="#f5c400">
            </div>
            <div class="stat">
              <span class="muted">جودة/حجم المجسم</span>
              <input id="size" type="range" min="4" max="14" step="1" value="8">
            </div>
          </div>
          <button id="addNationality">إضافة الجنسيـة</button>
        </div>

        <div class="control-group">
          <div class="nationality-header">
            <h3 style="margin:0; font-size:18px;">الجنسيات المشاركة</h3>
            <span class="badge" id="totalCount">الإجمالي: 0</span>
          </div>
          <div class="nationality-list" id="nationalityList"></div>
        </div>
      </div>
      <p class="footer-note">حرّك المؤشرات بالأعلى لزيادة العدد أو تغيير السرعة وحجم المجسم لكل جنسية.</p>
    </aside>
  </main>

  <script>
    const canvas = document.getElementById('tawafCanvas');
    const ctx = canvas.getContext('2d');
    const nationalitiesList = document.getElementById('nationalityList');
    const totalCountEl = document.getElementById('totalCount');

    const state = {
      nationalities: [
        { id: crypto.randomUUID(), name: 'السعودية', count: 26, speed: 0.6, color: '#f5c400', size: 8 },
        { id: crypto.randomUUID(), name: 'تركيا', count: 20, speed: 0.7, color: '#00c2ff', size: 7 },
        { id: crypto.randomUUID(), name: 'إندونيسيا', count: 24, speed: 0.9, color: '#8dff75', size: 7 },
      ],
      people: []
    };

    const radiusRange = [140, 220];

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      canvas.width = rect.width * devicePixelRatio;
      canvas.height = rect.height * devicePixelRatio;
      ctx.scale(devicePixelRatio, devicePixelRatio);
    }

    function drawBaseScene(width, height, centerX, centerY) {
      ctx.save();
      ctx.translate(centerX, centerY + 6);
      ctx.scale(1, 0.7);

      const outerRadius = radiusRange[1] + 120;
      const innerRadius = radiusRange[0] - 40;
      const floor = ctx.createRadialGradient(0, 0, 60, 0, 0, outerRadius);
      floor.addColorStop(0, 'rgba(255, 255, 255, 0.12)');
      floor.addColorStop(0.6, 'rgba(255, 255, 255, 0.06)');
      floor.addColorStop(1, 'rgba(90, 125, 160, 0.18)');

      ctx.fillStyle = floor;
      ctx.beginPath();
      ctx.arc(0, 0, outerRadius, 0, Math.PI * 2);
      ctx.fill();

      const matafRadius = (radiusRange[0] + radiusRange[1]) / 2 + 20;
      const band = ctx.createLinearGradient(-outerRadius, 0, outerRadius, 0);
      band.addColorStop(0, 'rgba(255, 255, 255, 0.35)');
      band.addColorStop(0.5, 'rgba(245, 196, 0, 0.45)');
      band.addColorStop(1, 'rgba(255, 255, 255, 0.35)');
      ctx.strokeStyle = band;
      ctx.lineWidth = 16;
      ctx.beginPath();
      ctx.arc(0, 0, matafRadius, 0, Math.PI * 2);
      ctx.stroke();

      const rings = [innerRadius, (innerRadius + radiusRange[0]) / 2, radiusRange[0], (radiusRange[0] + radiusRange[1]) / 2, radiusRange[1] + 12];
      rings.forEach((r, i) => {
        ctx.strokeStyle = `rgba(255, 255, 255, ${0.2 - i * 0.03})`;
        ctx.lineWidth = 1.4;
        ctx.setLineDash([10, 8]);
        ctx.beginPath();
        ctx.arc(0, 0, r, 0, Math.PI * 2);
        ctx.stroke();
      });
      ctx.setLineDash([]);

      ctx.strokeStyle = 'rgba(255,255,255,0.14)';
      ctx.lineWidth = 1.2;
      for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 14) {
        const r1 = innerRadius + 10;
        const r2 = outerRadius;
        ctx.beginPath();
        ctx.moveTo(Math.cos(angle) * r1, Math.sin(angle) * r1);
        ctx.lineTo(Math.cos(angle) * r2, Math.sin(angle) * r2);
        ctx.stroke();
      }

      ctx.restore();

      const shadow = ctx.createRadialGradient(centerX, centerY + 12, 12, centerX, centerY + 12, 130);
      shadow.addColorStop(0, 'rgba(0,0,0,0.4)');
      shadow.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = shadow;
      ctx.beginPath();
      ctx.ellipse(centerX, centerY + 10, 90, 56, 0, 0, Math.PI * 2);
      ctx.fill();
    }

    function rebuildPeople() {
      state.people = [];
      state.nationalities.forEach(nat => {
        for (let i = 0; i < nat.count; i++) {
          state.people.push({
            nationalityId: nat.id,
            angle: Math.random() * Math.PI * 2,
            radius: randomBetween(...radiusRange),
          });
        }
      });
      updateTotalCount();
    }

    function randomBetween(min, max) {
      return Math.random() * (max - min) + min;
    }

    function draw() {
      const width = canvas.clientWidth;
      const height = canvas.clientHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const centerX = width / 2;
      const centerY = height / 2;

      drawBaseScene(width, height, centerX, centerY);

      state.people.forEach(person => {
        const nat = state.nationalities.find(n => n.id === person.nationalityId);
        if (!nat) return;
        person.angle += nat.speed * 0.01;
        const x = centerX + Math.cos(person.angle) * person.radius;
        const y = centerY + Math.sin(person.angle) * person.radius * 0.65;
        const depthScale = 0.65 + 0.35 * (person.radius / radiusRange[1]);
        const size = nat.size * depthScale;

        const gradient = ctx.createRadialGradient(x, y, 0, x, y, size);
        gradient.addColorStop(0, nat.color + 'bb');
        gradient.addColorStop(1, nat.color + '00');

        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = '#0b1320';
        ctx.beginPath();
        ctx.arc(x, y - size * 0.3, size * 0.55, 0, Math.PI * 2);
        ctx.fill();
      });

      requestAnimationFrame(draw);
    }

    function updateTotalCount() {
      const total = state.nationalities.reduce((sum, nat) => sum + Number(nat.count || 0), 0);
      totalCountEl.textContent = `الإجمالي: ${total}`;
    }

    function renderNationalities() {
      nationalitiesList.innerHTML = '';
      state.nationalities.forEach(nat => {
        const container = document.createElement('div');
        container.className = 'nationality-item';
        container.innerHTML = `
          <div class="nationality-header">
            <span class="badge" style="background: ${nat.color}33; color: #fff;">
              <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${nat.color}"></span>
              ${nat.name}
            </span>
            <button data-id="${nat.id}" class="remove">حذف</button>
          </div>
          <div class="meta-grid">
            <label>العدد <input data-field="count" data-id="${nat.id}" type="number" min="1" max="500" value="${nat.count}"></label>
            <label>السرعة <input data-field="speed" data-id="${nat.id}" type="number" step="0.05" min="0.1" max="2.5" value="${nat.speed}"></label>
            <label>الحجم/الجودة <input data-field="size" data-id="${nat.id}" type="range" min="4" max="14" step="1" value="${nat.size}"></label>
          </div>
        `;
        nationalitiesList.appendChild(container);
      });
    }

    function addNationality() {
      const name = document.getElementById('name').value.trim();
      const count = Math.min(Math.max(1, Number(document.getElementById('count').value) || 1), 500);
      const speed = Math.min(Math.max(0.1, Number(document.getElementById('speed').value) || 0.1), 2.5);
      const color = document.getElementById('color').value;
      const size = Math.min(Math.max(4, Number(document.getElementById('size').value) || 8), 14);

      if (!name) return alert('أدخل اسم الجنسيـة أولاً');

      state.nationalities.push({ id: crypto.randomUUID(), name, count, speed, color, size });
      document.getElementById('name').value = '';
      rebuildPeople();
      renderNationalities();
    }

    function handleListInput(e) {
      const field = e.target.dataset.field;
      const id = e.target.dataset.id;
      if (!field || !id) return;
      const nat = state.nationalities.find(n => n.id === id);
      if (!nat) return;
      const value = Number(e.target.value);
      if (field === 'count') nat.count = Math.min(Math.max(1, value || nat.count), 500);
      if (field === 'speed') nat.speed = Math.min(Math.max(0.1, value || nat.speed), 2.5);
      if (field === 'size') nat.size = Math.min(Math.max(4, value || nat.size), 14);
      rebuildPeople();
    }

    function handleRemove(e) {
      if (!e.target.classList.contains('remove')) return;
      const id = e.target.dataset.id;
      state.nationalities = state.nationalities.filter(n => n.id !== id);
      rebuildPeople();
      renderNationalities();
    }

    document.getElementById('addNationality').addEventListener('click', addNationality);
    nationalitiesList.addEventListener('input', handleListInput);
    nationalitiesList.addEventListener('click', handleRemove);

    resizeCanvas();
    rebuildPeople();
    renderNationalities();
    draw();

    window.addEventListener('resize', () => {
      resizeCanvas();
      rebuildPeople();
    });
  </script>
</body>
</html>
